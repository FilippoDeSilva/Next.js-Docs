name: ðŸ§  Mirror & Archive Next.js Docs (Clean + Compressed + LFS)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"  # daily at 3 AM UTC

jobs:
  download-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y httrack wkhtmltopdf ghostscript git-lfs xvfb

      - name: Initialize Git LFS
        run: |
          git lfs install
          git lfs track "*.pdf"
          git add .gitattributes
          git commit -m "ðŸ§© Track PDFs with Git LFS" || echo "No new LFS tracking changes"

      - name: Mirror Next.js Docs only
        run: |
          rm -rf nextjs-docs
          httrack "https://nextjs.org/docs" \
            --path ./nextjs-docs \
            "+https://nextjs.org/docs*" "-*" \
            --stay-on-same-domain \
            --mirror \
            --robots=0 \
            --disable-security-limits \
            --keep-alive \
            --sockets=8 \
            --quiet

      - name: Inject CSS to hide headers, footers, navbars, and feedback
        run: |
          find nextjs-docs -type f -name "*.html" | while read page; do
            echo '<style>
            [class*="header-module__Pc0Sva__header"],
            [class*="header-module__Pc0Sva__sticky"],
            [class*="footer-module__rV1DKq__footer"],
            [class*="feedback-module__j8fpJW__inlineWrapper"],
            [class*="feedback-module__j8fpJW__inlineWrapperClosed"],
            div[class*="sticky"][class*="top-"][class*="md:flex"][class*="md:shrink-0"][class*="md:flex-col"][class*="md:justify-between"] {
              display: none !important;
              visibility: hidden !important;
              height: 0 !important;
              overflow: hidden !important;
            }
            </style>' >> "$page"
          done

      - name: Generate PDFs from mirrored HTML (parallel)
        run: |
          mkdir -p pdf_output
          find nextjs-docs -type f -name "*.html" | sort | xargs -n1 -P4 -I {} sh -c 'out="pdf_output/$(echo "{}" | sed "s|[/:]|-|g").pdf"; echo "ðŸ“„ Rendering {} â†’ $out"; xvfb-run wkhtmltopdf "{}" "$out"'

      - name: Merge all PDFs into single document
        run: |
          mkdir -p docs
          pdftk pdf_output/*.pdf cat output docs/NextJS_Docs_Complete.pdf

      - name: Compress final PDF
        run: |
          gs -sDEVICE=pdfwrite -dCompatibilityLevel=1.4 \
             -dPDFSETTINGS=/ebook \
             -dNOPAUSE -dQUIET -dBATCH \
             -sOutputFile=docs/NextJS_Docs_Complete_Compressed.pdf \
             docs/NextJS_Docs_Complete.pdf
          mv docs/NextJS_Docs_Complete_Compressed.pdf docs/NextJS_Docs_Complete.pdf

      - name: Commit & Push (via Git LFS)
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add docs/NextJS_Docs_Complete.pdf
          git commit -m "ðŸ“š Update Next.js Docs (clean & compressed PDF via LFS)" || echo "No PDF changes"
          git push origin main

      - name: Upload final PDF as artifact
        uses: actions/upload-artifact@v4
        with:
          name: NextJS_Docs_Complete
          path: docs/NextJS_Docs_Complete.pdf