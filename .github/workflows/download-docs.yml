name: Update Next.js Docs

on:
  schedule:
    - cron: "0 0 * * *"   # every midnight UTC
  workflow_dispatch:

jobs:
  update-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wkhtmltopdf curl pup

      - name: Check for docs changes
        id: check
        run: |
          mkdir -p .cache
          curl -s https://nextjs.org/docs | sha256sum | cut -d' ' -f1 > .cache/stable.hash.new
          curl -s https://nextjs.org/docs/canary | sha256sum | cut -d' ' -f1 > .cache/canary.hash.new

          # Save old hashes if exist
          touch .cache/stable.hash .cache/canary.hash

          if cmp -s .cache/stable.hash .cache/stable.hash.new && cmp -s .cache/canary.hash .cache/canary.hash.new; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            mv .cache/stable.hash.new .cache/stable.hash
            mv .cache/canary.hash.new .cache/canary.hash
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Crawl & Build Stable PDF
        if: steps.check.outputs.changed == 'true'
        run: |
          mkdir -p pdf-docs
          echo "ðŸŒ Crawling stable docs..."
          curl -s https://nextjs.org/docs | pup 'a attr{href}' \
            | grep '^/docs/' | sort -u \
            | sed 's|^|https://nextjs.org|' > stable_links.txt
          
          echo "ðŸ“š Building Stable PDF..."
          wkhtmltopdf --quiet --no-outline --enable-local-file-access $(cat stable_links.txt) pdf-docs/nextjs-stable.pdf

      - name: Crawl & Build Canary PDF
        if: steps.check.outputs.changed == 'true'
        run: |
          echo "ðŸŒ Crawling canary docs..."
          curl -s https://nextjs.org/docs/canary | pup 'a attr{href}' \
            | grep '^/docs/' | sort -u \
            | sed 's|^|https://nextjs.org|' > canary_links.txt
          
          echo "ðŸ“š Building Canary PDF..."
          wkhtmltopdf --quiet --no-outline --enable-local-file-access $(cat canary_links.txt) pdf-docs/nextjs-canary.pdf

      - name: Commit and push changes
        if: steps.check.outputs.changed == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add pdf-docs .cache || echo "No files to add"
          git commit -m "ðŸ“š Update Next.js docs ($(date -u +'%Y-%m-%d %H:%M:%S UTC'))"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload PDFs as artifact
        if: steps.check.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-docs-pdfs
          path: pdf-docs/
          if-no-files-found: error