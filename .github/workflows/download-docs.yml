name: Generate Professional Next.js Docs PDF

on:
  workflow_dispatch:

jobs:
  build-pdf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install puppeteer cheerio highlight.js

      - name: Generate Professional PDF
        env:
          INPUT_TIMEOUT: 120000 # Extend navigation timeout
        run: |
          node <<'JS'
          const fs = require('fs');
          const puppeteer = require('puppeteer');
          const cheerio = require('cheerio');
          const hljs = require('highlight.js');

          const outputFile = 'NextJS_Docs_Professional.pdf';
          const baseUrl = 'https://nextjs.org/docs';
          const timeout = parseInt(process.env.INPUT_TIMEOUT || '60000');

          (async () => {
            const browser = await puppeteer.launch({
              headless: true,
              args: [
                '--no-sandbox',
                '--disable-setuid-sandbox',
                '--disable-dev-shm-usage',
                '--disable-gpu',
                '--single-process',
                '--no-zygote'
              ]
            });
            const page = await browser.newPage();
            await page.setViewport({ width: 1440, height: 1024 });

            // Remove left nav, headers, footers
            await page.evaluateOnNewDocument(() => {
              const observer = new MutationObserver(() => {
                const leftNav = document.querySelector('aside');
                const header = document.querySelector('header');
                const footer = document.querySelector('footer');
                if (leftNav) leftNav.style.display = 'none';
                if (header) header.style.display = 'none';
                if (footer) footer.style.display = 'none';
              });
              observer.observe(document.body, { childList: true, subtree: true });
            });

            // Collect doc links
            await page.goto(baseUrl, { waitUntil: 'networkidle2', timeout });
            const links = await page.evaluate(() =>
              Array.from(document.querySelectorAll('a'))
                .map(a => a.href)
                .filter(h => h.includes('/docs/app'))
            );

            const pdfPages = [];

            for (const link of links) {
              try {
                await page.goto(link, { waitUntil: 'networkidle2', timeout });

                // Wait extra for images/code to render
                await page.waitForTimeout(4000);

                const content = await page.content();
                const $ = cheerio.load(content);

                // Highlight code blocks and make scrollable
                $('pre code').each((i, block) => {
                  const code = $(block).text();
                  let langClass = $(block).attr('class') || '';
                  let lang = 'plaintext';
                  const match = langClass.match(/language-(\w+)/);
                  if (match) lang = match[1];

                  try {
                    const highlighted = hljs.highlight(code, { language: lang }).value;
                    $(block).html(highlighted);
                  } catch {
                    const safeHighlighted = hljs.highlight(code, { language: 'plaintext' }).value;
                    $(block).html(safeHighlighted);
                    console.warn(`Unknown language "${langClass}", defaulted to plaintext`);
                  }

                  $(block).css({
                    'overflow-x': 'auto',
                    'display': 'block',
                    'white-space': 'pre'
                  });
                });

                // Center content
                $('main').css({
                  'margin': '0 auto',
                  'max-width': '900px'
                });

                // Light background, dark mode removed
                $('body').css({
                  'background-color': '#ffffff',
                  'color': '#000000'
                });

                pdfPages.push($.html());
                console.log(`Added ${link} to PDF`);
              } catch (err) {
                console.warn(`Error fetching ${link}:`, err.message);
              }
            }

            // Compile all HTML pages
            const pdfPage = await browser.newPage();
            await pdfPage.setContent(pdfPages.join('<div style="page-break-after: always;"></div>'), { waitUntil: 'networkidle2' });

            // Generate PDF
            await pdfPage.pdf({
              path: outputFile,
              format: 'A4',
              printBackground: true,
              margin: { top: '20px', bottom: '20px', left: '20px', right: '20px' }
            });

            await browser.close();
            console.log(`Professional PDF generated: ${outputFile}`);
          })();
          JS

      - name: Upload PDF as artifact
        uses: actions/upload-artifact@v4
        with:
          name: NextJS_Docs_Professional
          path: NextJS_Docs_Professional.pdf