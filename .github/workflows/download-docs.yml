name: üß† Mirror & Archive Next.js Docs (with PDF compression + artifact)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"  # daily at 3 AM UTC

jobs:
  download-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true   # ensure LFS-tracked files are properly checked out

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y httrack wkhtmltopdf pdftk ghostscript git-lfs

      - name: Initialize Git LFS
        run: |
          echo "‚öôÔ∏è Initializing Git LFS..."
          git lfs install
          git lfs track "*.pdf"
          git add .gitattributes
          git commit -m "üß© Track PDFs with Git LFS" || echo "No new LFS tracking changes"

      - name: Mirror Next.js Docs only
        run: |
          echo "üì• Mirroring Next.js Docs..."
          rm -rf nextjs-docs
          httrack "https://nextjs.org/docs" \
            --path ./nextjs-docs \
            "+https://nextjs.org/docs*" "-*" \
            --stay-on-same-domain \
            --mirror \
            --robots=0 \
            --disable-security-limits \
            --keep-alive \
            --sockets=8 \
            --quiet

      - name: Generate PDFs from mirrored HTML
        run: |
          mkdir -p pdf_output
          find nextjs-docs -type f -name "*.html" | sort | while read page; do
            out="pdf_output/$(echo $page | sed 's|[/:]|-|g').pdf"
            echo "üìÑ Rendering $page ‚Üí $out"
            wkhtmltopdf "$page" "$out"
          done

      - name: Merge all PDFs into single structured document
        run: |
          echo "üß© Merging all PDFs..."
          mkdir -p docs
          pdftk pdf_output/*.pdf cat output docs/NextJS_Docs_Complete.pdf
          echo "‚úÖ Merged PDF ready: docs/NextJS_Docs_Complete.pdf"

      - name: Compress merged PDF
        run: |
          echo "üóúÔ∏è Compressing merged PDF (ghostscript)..."
          gs -sDEVICE=pdfwrite -dCompatibilityLevel=1.4 \
             -dPDFSETTINGS=/ebook \
             -dNOPAUSE -dQUIET -dBATCH \
             -sOutputFile=docs/NextJS_Docs_Complete_Compressed.pdf \
             docs/NextJS_Docs_Complete.pdf
          echo "‚úÖ Compressed PDF ready: docs/NextJS_Docs_Complete_Compressed.pdf"

      - name: Commit & Push (with LFS)
        run: |
          echo "üöÄ Committing & pushing via Git LFS..."
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add docs/NextJS_Docs_Complete_Compressed.pdf
          git commit -m "üìö Update compressed Next.js Docs (Git LFS upload)" || echo "No PDF changes"
          git push origin main

      - name: Upload compressed PDF as artifact
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-docs-compressed
          path: docs/NextJS_Docs_Complete_Compressed.pdf