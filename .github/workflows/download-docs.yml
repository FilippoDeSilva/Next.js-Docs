name: Mirror Next.js Docs

on:
  workflow_dispatch:

jobs:
  mirror-docs:
    runs-on: ubuntu-latest
    steps:
      - name: üåê Checkout repository
        uses: actions/checkout@v3

      - name: üîß Install HTTrack
        run: |
          sudo apt-get update
          sudo apt-get install -y httrack

      - name: üìÑ Mirror nextjs.org/docs
        run: |
          echo "üåê Starting HTTrack mirror of nextjs.org/docs..."
          mkdir -p docs_mirror
          
          LOG_FILE="docs_mirror/httrack.log"
          > "$LOG_FILE"
          
          # Run HTTrack in correct syntax for 3.49-5
          httrack "https://nextjs.org/docs" \
              -O docs_mirror \
              --robots=0 \
              --stay-on-same-domain \
              "-*" \
              "+https://nextjs.org/docs*" \
              -c4 \
              -r3 \
              --keep-alive \
              --continue \
              -v \
              -f "$LOG_FILE"
          
          echo "‚è≥ Mirroring in progress..."
          HT_PID=$!
          while kill -0 $HT_PID 2>/dev/null; do
              DOWNLOADED=$(grep -c "Saving" docs_mirror/hts-cache/* 2>/dev/null || echo 0)
              printf "\rüìÑ Pages downloaded so far: %d" "$DOWNLOADED"
              sleep 3
          done
          wait $HT_PID
          
          DOWNLOADED=$(grep -c "Saving" docs_mirror/hts-cache/* 2>/dev/null || echo 0)
          echo
          echo "‚úÖ HTTrack finished. Total pages downloaded: $DOWNLOADED"

      - name: üìÇ Detect docs folder
        run: |
          DOCS_DIR=$(find docs_mirror -type d -name "docs" | head -1)
          if [[ -z "$DOCS_DIR" ]]; then
            echo "‚ùå Could not find docs folder!"
            exit 1
          fi
          echo "Detected docs folder: $DOCS_DIR"

      - name: ‚úÖ Done
        run: echo "Docs mirror is ready at $DOCS_DIR"