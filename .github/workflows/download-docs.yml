name: Build Next.js Canary Docs PDF (MDX + LaTeX template)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # daily at midnight UTC

jobs:
  build-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pandoc \
            texlive-xetex \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-fonts-recommended \
            fonts-dejavu-core \
            python3-pygments \
            git \
            graphviz

      - name: Clone Next.js repository (canary)
        run: |
          set -euo pipefail
          REPO="https://github.com/vercel/next.js.git"
          DOCS_DIR="nextjs-docs/canary_docs"
          rm -rf "$DOCS_DIR"

          echo "Cloning default branch (canary branch is not official)"
          git clone --depth=1 "$REPO" "$DOCS_DIR"

      - name: Get latest docs commit hash
        id: get_hash
        run: |
          LATEST=$(git -C nextjs-docs/canary_docs rev-parse --short HEAD)
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

      - name: Read previous docs hash (if any)
        id: get_old
        run: |
          OLD=$(cat docs_hash.txt 2>/dev/null || echo "")
          echo "old=$OLD" >> $GITHUB_OUTPUT

      - name: Build PDF (only if docs changed)
        if: ${{ steps.get_hash.outputs.latest != steps.get_old.outputs.old }}
        run: |
          set -euo pipefail
          echo "Docs changed. Building PDF..."

          mkdir -p pdf-docs
          DOCS_PATH="nextjs-docs/canary_docs/docs"
          TEMPLATE="nextjs-template.tex"

          if [ ! -f "$TEMPLATE" ]; then
            echo "ERROR: LaTeX template $TEMPLATE not found."
            exit 1
          fi

          # Ensure \tightlist fix exists in template
          grep -q '\\tightlist' "$TEMPLATE" || echo -e "\n% Fix for Pandoc tightlist\n\\providecommand{\\tightlist}{\\setlength{\\itemsep}{0pt}\\setlength{\\parskip}{0pt}}" >> "$TEMPLATE"

          # Find all .md and .mdx files
          mapfile -t files < <(find "$DOCS_PATH" -type f \( -name "*.md" -o -name "*.mdx" \) | sort)
          if [ "${#files[@]}" -eq 0 ]; then
            echo "No Markdown/MDX files found in $DOCS_PATH"
            exit 1
          fi

          echo "Found ${#files[@]} files. Sample:"
          printf '%s\n' "${files[@]:0:10}"

          # Build PDF with LaTeX template using minted and shell-escape
          pandoc "${files[@]}" \
            -o pdf-docs/NextJS_Canary_Docs.pdf \
            --pdf-engine=xelatex \
            --pdf-engine-opt=-shell-escape \
            --toc \
            --toc-depth=3 \
            --highlight-style=pygments \
            --from=markdown+raw_tex \
            --template="$TEMPLATE" \
            -V geometry:margin=1in \
            -V linkcolor=blue \
            -V colorlinks=true \
            -V fontsize=11pt \
            -V mainfont="DejaVu Serif" \
            -V title="Next.js Canary Documentation" \
            -V author="Vercel / Next.js Community" \
            -V date="$(date -u +'%Y-%m-%d UTC')" \
            -V version="${{ steps.get_hash.outputs.latest }}"

          # Record new hash
          echo "${{ steps.get_hash.outputs.latest }}" > docs_hash.txt
          echo "Recorded new docs hash."

      - name: Generate changelog of updated docs
        if: ${{ steps.get_hash.outputs.latest != steps.get_old.outputs.old }}
        id: changelog
        run: |
          git -C nextjs-docs/canary_docs diff --name-only ${{ steps.get_old.outputs.old }} ${{ steps.get_hash.outputs.latest }} > docs-changed.txt || echo "" > docs-changed.txt
          CHANGES=$(cat docs-changed.txt)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload PDF artifact
        if: ${{ steps.get_hash.outputs.latest != steps.get_old.outputs.old }}
        uses: actions/upload-artifact@v4
        with:
          name: NextJS-Canary-Docs
          path: pdf-docs/NextJS_Canary_Docs.pdf

      - name: Create / Update PR with updated PDF + changelog
        if: ${{ steps.get_hash.outputs.latest != steps.get_old.outputs.old }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(docs): update Next.js Canary PDF — ${{ steps.get_hash.outputs.latest }}"
          branch: update-nextjs-canary-docs
          title: "Update Next.js Canary Docs PDF — ${{ steps.get_hash.outputs.latest }}"
          body: |
            Automated update of the Next.js Canary docs PDF.

            - docs commit: `${{ steps.get_hash.outputs.latest }}`
            - updated files:
              ${{ steps.changelog.outputs.changelog }}
          base: main