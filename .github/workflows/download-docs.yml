name: ðŸ§  Mirror & Archive Next.js Docs (with Git LFS)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"  # daily at 3 AM UTC

jobs:
  download-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y httrack wkhtmltopdf pdftk git-lfs ghostscript xvfb

      - name: Initialize Git LFS
        run: |
          git lfs install
          git lfs track "*.pdf"
          git add .gitattributes
          git commit -m "ðŸ§© Track PDFs with Git LFS" || echo "No new LFS tracking changes"

      - name: Mirror Next.js Docs only
        run: |
          rm -rf nextjs-docs
          httrack "https://nextjs.org/docs" \
            --path ./nextjs-docs \
            "+https://nextjs.org/docs*" "-*" \
            --stay-on-same-domain \
            --mirror \
            --robots=0 \
            --disable-security-limits \
            --keep-alive \
            --sockets=8 \
            --quiet

      - name: Generate PDFs from mirrored HTML (parallel)
        run: |
          mkdir -p pdf_output
          # create CSS file to hide headers, footers, navbar, feedback
          echo "
          [class*=\"header-module__Pc0Sva__header\"],
          [class*=\"header-module__Pc0Sva__sticky\"],
          [class*=\"footer-module__rV1DKq__footer\"],
          [class*=\"feedback-module__j8fpJW__inlineWrapper\"],
          [class*=\"feedback-module__j8fpJW__inlineWrapperClosed\"],
          div[class*=\"sticky\"][class*=\"top-\"][class*=\"md:flex\"][class*=\"md:shrink-0\"][class*=\"md:flex-col\"][class*=\"md:justify-between\"] {
              display: none !important;
              visibility: hidden !important;
              height: 0 !important;
              overflow: hidden !important;
          }
          " > hide_sections.css

          find nextjs-docs -type f -name "*.html" | sort | xargs -P4 -I {} sh -c '
            out="pdf_output/$(echo "{}" | sed "s|[/:]|-|g").pdf"
            echo "ðŸ“„ Rendering {} â†’ $out"
            xvfb-run wkhtmltopdf \
              --enable-local-file-access \
              --load-error-handling ignore \
              --no-background \
              --user-style-sheet hide_sections.css \
              "{}" "$out"
          '

      - name: Merge all PDFs into single structured document
        run: |
          mkdir -p docs
          pdftk pdf_output/*.pdf cat output docs/NextJS_Docs_Complete.pdf
          echo "âœ… Merged PDF ready: docs/NextJS_Docs_Complete.pdf"

      - name: Compress PDF to reduce size
        run: |
          gs -sDEVICE=pdfwrite -dCompatibilityLevel=1.4 -dPDFSETTINGS=/ebook \
             -dNOPAUSE -dQUIET -dBATCH \
             -sOutputFile=docs/NextJS_Docs_Complete_Compressed.pdf \
             docs/NextJS_Docs_Complete.pdf
          mv docs/NextJS_Docs_Complete_Compressed.pdf docs/NextJS_Docs_Complete.pdf
          echo "âœ… PDF compressed"

      - name: Commit & Push (with LFS)
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add docs/NextJS_Docs_Complete.pdf
          git commit -m "ðŸ“š Update Next.js Docs (Git LFS upload)" || echo "No PDF changes"
          git push origin main

      - name: Upload Final PDF as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: NextJS_Docs_Complete
          path: docs/NextJS_Docs_Complete.pdf