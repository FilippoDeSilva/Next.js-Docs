name: Download Next.js Docs

on:
  schedule:
    - cron: '0 0 * * *'   # midnight UTC daily
  workflow_dispatch:

jobs:
  download_docs:
    runs-on: ubuntu-latest

    env:   # ðŸ‘ˆ this must be inside the job, same level as runs-on
      OUTPUT_DIR: ${{ github.workspace }}/nextjs-docs-tmp
      REPO_DOCS_DIR: nextjs-docs
      HASH_FILE: ${{ github.workspace }}/docs_hash.txt

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v2

      - name: Install HTTrack and Curl
        run: |
          sudo apt-get update
          sudo apt-get install -y httrack curl

      - name: Prepare for Download
        run: |
          mkdir -p "$OUTPUT_DIR"
          mkdir -p "$REPO_DOCS_DIR"

          # Generate new docs hash
          NEW_HASH=$(curl -s https://nextjs.org/docs | md5sum | cut -d ' ' -f1)
          echo "New Hash: $NEW_HASH"

          if [ -f "$HASH_FILE" ]; then
            OLD_HASH=$(cat "$HASH_FILE")
            echo "Old Hash: $OLD_HASH"

            if [ "$NEW_HASH" == "$OLD_HASH" ]; then
              echo "Docs have not changed. Skipping download."
              exit 0
            fi
          fi

          # Download docs
          httrack https://nextjs.org/docs -O "$OUTPUT_DIR" "+*.nextjs.org/*" -v

          # Save hash for next run
          echo $NEW_HASH > "$HASH_FILE"

      - name: Commit and push updated docs to the repository
        run: |
          cp -r "$OUTPUT_DIR"/* "$REPO_DOCS_DIR"

          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add "$REPO_DOCS_DIR"
          git commit -m "Update Next.js Docs" || echo "No changes to commit"
          git push origin main