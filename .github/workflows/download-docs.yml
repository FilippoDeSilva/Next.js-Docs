name: 🧠 Mirror & Archive Next.js Docs (with Git LFS + Release Upload)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *" # daily at 3 AM UTC

jobs:
  download-docs:
    runs-on: ubuntu-latest

    env:
      BASE_URL: https://nextjs.org
      DOCS_PATH: /docs
      PDF_DIR: pdf_output
      FINAL_DIR: docs
      FINAL_PDF: NextJS_Docs_Complete.pdf

    steps:
      - name: 🧩 Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: ⚙️ Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y httrack wkhtmltopdf pdftk git-lfs ghostscript xvfb

      - name: 🧠 Initialize Git LFS
        run: |
          git lfs install
          git lfs track "*.pdf"
          git add .gitattributes
          git commit -m "Enable Git LFS for PDFs" || echo "No new tracking changes"

      - name: 🌐 Mirror Next.js Docs only
        run: |
          echo "📥 Mirroring Next.js Docs..."
          rm -rf nextjs-docs
          httrack "${BASE_URL}${DOCS_PATH}" \
            --path ./nextjs-docs \
            "+${BASE_URL}${DOCS_PATH}*" "-*" \
            --stay-on-same-domain --mirror --robots=0 \
            --disable-security-limits --keep-alive \
            --sockets=8 --quiet

      - name: 🧾 Generate PDFs from mirrored HTML
        run: |
          mkdir -p "${PDF_DIR}"

          # CSS to hide unwanted sections (header, footer, sidebar, feedback)
          cat > hide_sections.css <<'EOF'
          [class*="header-module__Pc0Sva__header"],
          [class*="header-module__Pc0Sva__sticky"],
          [class*="footer-module__rV1DKq__footer"],
          [class*="feedback-module__j8fpJW__inlineWrapper"],
          [class*="feedback-module__j8fpJW__inlineWrapperClosed"],
          div[class*="sticky"][class*="top-"][class*="md:flex"][class*="md:shrink-0"][class*="md:flex-col"][class*="md:justify-between"] {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            overflow: hidden !important;
          }
          EOF

          echo "📄 Generating PDFs..."
          find nextjs-docs -type f -name "*.html" | sort | xargs -P4 -I {} sh -c '
            out="${PDF_DIR}/$(echo "{}" | sed "s|[/:]|-|g").pdf"
            echo "📄 Rendering {} → $out"
            xvfb-run wkhtmltopdf \
              --enable-local-file-access \
              --load-error-handling ignore \
              --no-background \
              --user-style-sheet hide_sections.css \
              "{}" "$out"
          '

      - name: 🧩 Merge and compress final PDF
        run: |
          mkdir -p "${FINAL_DIR}"
          echo "📚 Merging PDFs..."
          pdftk ${PDF_DIR}/*.pdf cat output "${FINAL_DIR}/${FINAL_PDF%.pdf}_merged.pdf"

          echo "📦 Compressing final PDF..."
          gs -sDEVICE=pdfwrite -dCompatibilityLevel=1.4 -dPDFSETTINGS=/ebook \
             -dNOPAUSE -dQUIET -dBATCH \
             -sOutputFile="${FINAL_DIR}/${FINAL_PDF}" \
             "${FINAL_DIR}/${FINAL_PDF%.pdf}_merged.pdf"

          rm -f "${FINAL_DIR}/${FINAL_PDF%.pdf}_merged.pdf"
          echo "✅ Final compressed PDF ready: ${FINAL_DIR}/${FINAL_PDF}"

      - name: 🚀 Commit, Push & Tag Version
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"

          echo "🧹 Cleaning workspace..."
          git reset --hard
          git clean -fd
          git pull --rebase --autostash origin main || git pull origin main

          git add "${FINAL_DIR}/${FINAL_PDF}"
          git commit -m "📚 Update Next.js Docs archive (compressed, full fidelity)" || echo "No PDF changes"
          git push origin main

          VERSION_TAG="v$(date +'%Y.%m.%d')"
          git tag -a "$VERSION_TAG" -m "📘 Next.js Docs snapshot for $VERSION_TAG"
          git push origin "$VERSION_TAG"

      - name: 💾 Upload as Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: NextJS_Docs_Complete
          path: docs/NextJS_Docs_Complete.pdf

      - name: 🚢 Create GitHub Release & Upload Asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_id }}
          name: "Next.js Docs Snapshot ${{ github.run_number }}"
          body: |
            📘 **Next.js Docs Archive**
            This release contains the latest mirrored and compressed PDF documentation snapshot of Next.js.
          files: |
            docs/NextJS_Docs_Complete.pdf
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}