name: Generate Full Next.js Docs PDF

on:
  workflow_dispatch:

jobs:
  build-pdf:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install puppeteer axios cheerio fs

      - name: Generate Full Next.js Docs PDF
        run: |
          node <<'JS'
          const fs = require('fs');
          const puppeteer = require('puppeteer');
          const cheerio = require('cheerio');
          const axios = require('axios');

          const baseUrl = 'https://nextjs.org/docs';

          (async () => {
            // Step 1: Scrape homepage for all doc links
            const homepage = await axios.get(baseUrl);
            const $ = cheerio.load(homepage.data);
            const links = Array.from($('a'))
              .map(a => a.attribs.href)
              .filter(h => h && h.startsWith('/docs/app'))
              .map(h => `https://nextjs.org${h}`);

            console.log(`Found ${links.length} doc pages...`);

            // Step 2: Fetch pages in parallel
            const pages = await Promise.allSettled(
              links.map(async (link, i) => {
                try {
                  const { data } = await axios.get(link);
                  const $ = cheerio.load(data);

                  // Remove unwanted sections
                  $('[data-testid="was-this-helpful"]').remove();
                  $('header, footer, nav').remove();

                  // Fix code blocks: scrollable
                  $('pre code').each((_, el) => {
                    $(el).css({
                      'overflow-x': 'auto',
                      'display': 'block',
                      'white-space': 'pre'
                    });
                  });

                  console.log(`✔ Processed ${i+1}/${links.length}: ${link}`);
                  return `<section style="max-width:900px;margin:0 auto;">
                    <h1>${$('h1').first().text()}</h1>
                    ${$('main').html() || $('body').html()}
                    <hr style="margin:40px 0;"/>
                  </section>`;
                } catch (err) {
                  console.warn(`❌ Failed ${link}:`, err.message);
                  return '';
                }
              })
            );

            // Step 3: Combine into one HTML doc (keeping original CSS/JS/images)
            const allContent = pages.map(p => (p.status === 'fulfilled' ? p.value : '')).join('\n');

            const finalHTML = `
              <html>
              <head>
                <meta charset="utf-8"/>
                <title>Next.js Docs</title>
                <link rel="stylesheet" href="https://nextjs.org/_next/static/css/app.css" />
                <style>
                  body { font-family: Arial, sans-serif; line-height: 1.6; background: #fff; color: #000; }
                  pre { background: #f5f5f5; padding: 10px; border-radius: 6px; }
                  pre code { font-family: monospace; }
                  h1, h2, h3 { font-weight: bold; }
                </style>
              </head>
              <body>
                ${allContent}
              </body>
              </html>
            `;

            fs.writeFileSync('docs.html', finalHTML);

            // Step 4: Render once with Puppeteer
            const browser = await puppeteer.launch({
              headless: true,
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            const page = await browser.newPage();
            await page.goto(`file://${process.cwd()}/docs.html`, { waitUntil: 'networkidle0' });

            await page.pdf({
              path: 'NextJS_Docs_Full.pdf',
              format: 'A4',
              printBackground: true,
              margin: { top: '20px', bottom: '20px', left: '20px', right: '20px' }
            });

            await browser.close();
            console.log("✅ Full PDF generated successfully!");
          })();
          JS

      - name: Upload PDF
        uses: actions/upload-artifact@v4
        with:
          name: NextJS_Docs_Full
          path: NextJS_Docs_Full.pdf