name: Build Next.js Canary Docs PDF (MDX → PDF)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # daily at midnight UTC

jobs:
  build-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Node.js and dependencies
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install required packages
        run: |
          sudo apt-get update
          sudo apt-get install -y git chromium-browser
          npm install -g @mdx-js/mdx puppeteer html-pdf

      - name: Clone or update Next.js docs
        run: |
          set -euo pipefail
          REPO="https://github.com/vercel/next.js.git"
          DOCS_DIR="nextjs-docs/canary_docs"
          rm -rf "$DOCS_DIR"

          if git ls-remote --exit-code --heads "$REPO" canary >/dev/null 2>&1; then
            git clone --depth=1 --branch canary "$REPO" "$DOCS_DIR"
          else
            git clone --depth=1 "$REPO" "$DOCS_DIR"
          fi

      - name: Get latest docs commit hash
        id: get_hash
        run: |
          LATEST=$(git -C nextjs-docs/canary_docs rev-parse --short HEAD)
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

      - name: Read previous docs hash (if any)
        id: get_old
        run: |
          OLD=$(cat docs_hash.txt 2>/dev/null || echo "")
          echo "old=$OLD" >> $GITHUB_OUTPUT

      - name: Build PDF from MDX (if docs changed)
        if: ${{ steps.get_hash.outputs.latest != steps.get_old.outputs.old }}
        run: |
          set -euo pipefail
          mkdir -p pdf-docs
          DOCS_PATH="nextjs-docs/canary_docs/docs"
          HTML_FILE="pdf-docs/NextJS_Canary_Docs.html"
          PDF_FILE="pdf-docs/NextJS_Canary_Docs.pdf"

          # Convert all MDX to HTML
          echo "<html><head><meta charset='UTF-8'></head><body>" > "$HTML_FILE"
          for f in $(find "$DOCS_PATH" -type f \( -name "*.md" -o -name "*.mdx" \) | sort); do
            npx @mdx-js/mdx "$f" --output-file tmp.js
            node -e "const mdx = require('./tmp.js'); process.stdout.write('<div>'+mdx+'</div>');" >> "$HTML_FILE"
          done
          echo "</body></html>" >> "$HTML_FILE"

          # Convert HTML → PDF using Puppeteer
          node -e "
            const puppeteer = require('puppeteer');
            (async () => {
              const browser = await puppeteer.launch({args:['--no-sandbox','--disable-setuid-sandbox']});
              const page = await browser.newPage();
              await page.goto('file://' + process.cwd() + '/$HTML_FILE', {waitUntil: 'networkidle0'});
              await page.pdf({path: '$PDF_FILE', format: 'A4', printBackground: true});
              await browser.close();
            })();
          "

          # Record new hash
          echo "${{ steps.get_hash.outputs.latest }}" > docs_hash.txt
          echo "Recorded new docs hash."

      - name: Generate changelog of updated docs
        if: ${{ steps.get_hash.outputs.latest != steps.get_old.outputs.old }}
        id: changelog
        run: |
          git -C nextjs-docs/canary_docs diff --name-only ${{ steps.get_old.outputs.old }} ${{ steps.get_hash.outputs.latest }} > docs-changed.txt || echo "" > docs-changed.txt
          CHANGES=$(cat docs-changed.txt)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload PDF artifact
        if: ${{ steps.get_hash.outputs.latest != steps.get_old.outputs.old }}
        uses: actions/upload-artifact@v4
        with:
          name: NextJS-Canary-Docs
          path: pdf-docs/NextJS_Canary_Docs.pdf

      - name: Create / Update PR with updated PDF + changelog
        if: ${{ steps.get_hash.outputs.latest != steps.get_old.outputs.old }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(docs): update Next.js Canary PDF — ${{ steps.get_hash.outputs.latest }}"
          branch: update-nextjs-canary-docs
          title: "Update Next.js Canary Docs PDF — ${{ steps.get_hash.outputs.latest }}"
          body: |
            Automated update of the Next.js Canary docs PDF.

            - docs commit: `${{ steps.get_hash.outputs.latest }}`
            - updated files:
              ${{ steps.changelog.outputs.changelog }}
          base: main