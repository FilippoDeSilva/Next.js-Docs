name: ðŸ§  Mirror & Archive Next.js Docs (with Git LFS & Compression)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"  # daily at 3 AM UTC

jobs:
  download-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y httrack wkhtmltopdf pdftk git-lfs ghostscript

      - name: Initialize Git LFS
        run: |
          git lfs install
          git lfs track "*.pdf"
          git add .gitattributes
          git commit -m "ðŸ§© Track PDFs with Git LFS" || echo "No new LFS tracking changes"

      - name: Mirror Next.js Docs only
        run: |
          echo "ðŸ“¥ Mirroring Next.js Docs..."
          rm -rf nextjs-docs
          httrack "https://nextjs.org/docs" \
            --path ./nextjs-docs \
            "+https://nextjs.org/docs*" "-*" \
            --stay-on-same-domain \
            --mirror \
            --robots=0 \
            --disable-security-limits \
            --keep-alive \
            --sockets=8 \
            --quiet

      - name: Generate PDFs from mirrored HTML (parallel)
        run: |
          mkdir -p pdf_output
          find nextjs-docs -type f -name "*.html" | sort | xargs -P4 -I {} sh -c '
            out="pdf_output/$(echo "{}" | sed "s|[/:]|-|g").pdf"
            echo "ðŸ“„ Rendering {} â†’ $out"
            xvfb-run wkhtmltopdf \
              --enable-local-file-access \
              --load-error-handling ignore \
              --no-background \
              --user-style-sheet <(echo "
                /* Hide headers, footers, left navbar, feedback */
                [class*=\"header-module__Pc0Sva__header\"],
                [class*=\"header-module__Pc0Sva__sticky\"],
                [class*=\"footer-module__rV1DKq__footer\"],
                [class*=\"feedback-module__j8fpJW__inlineWrapper\"],
                [class*=\"feedback-module__j8fpJW__inlineWrapperClosed\"],
                div[class*=\"sticky\"][class*=\"top-\"][class*=\"md:flex\"][class*=\"md:shrink-0\"][class*=\"md:flex-col\"][class*=\"md:justify-between\"] {
                    display: none !important;
                    visibility: hidden !important;
                    height: 0 !important;
                    overflow: hidden !important;
                }
              ") \
              "{}" "$out"
          '

      - name: Compress PDFs to reduce size
        run: |
          mkdir -p pdf_compressed
          for f in pdf_output/*.pdf; do
            out="pdf_compressed/$(basename "$f")"
            echo "ðŸ—œ Compressing $f â†’ $out"
            gs -sDEVICE=pdfwrite -dCompatibilityLevel=1.4 -dPDFSETTINGS=/ebook \
               -dNOPAUSE -dQUIET -dBATCH -sOutputFile="$out" "$f"
          done

      - name: Merge all PDFs into single structured document
        run: |
          echo "ðŸ§© Merging all PDFs..."
          mkdir -p docs
          pdftk pdf_compressed/*.pdf cat output docs/NextJS_Docs_Complete.pdf
          echo "âœ… Final PDF ready: docs/NextJS_Docs_Complete.pdf"

      - name: Commit & Push via Git LFS
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add docs/NextJS_Docs_Complete.pdf
          git commit -m "ðŸ“š Update Next.js Docs (Git LFS upload)" || echo "No PDF changes"
          git push origin main || echo "Push failed (probably no changes)"

      - name: Upload Final PDF as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: NextJS_Docs_Complete
          path: docs/NextJS_Docs_Complete.pdf