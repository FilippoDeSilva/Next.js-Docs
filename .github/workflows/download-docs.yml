name: ðŸ“š Mirror & Archive Next.js Docs (No LFS, PDF commit, Artifact)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      BASE_URL: https://nextjs.org
      DOCS_PATH: /docs
      PDF_DIR: pdf_output
      FINAL_DIR: docs
      FINAL_PDF: NextJS_Docs_Complete.pdf

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y httrack wkhtmltopdf pdftk ghostscript xvfb

      - name: Mirror Next.js docs (only /docs)
        run: |
          rm -rf nextjs-docs
          httrack "${BASE_URL}${DOCS_PATH}" \
            --path nextjs-docs \
            "+${BASE_URL}${DOCS_PATH}*" "-*" \
            --stay-on-same-domain --mirror --robots=0 \
            --disable-security-limits --keep-alive \
            --sockets=8

      - name: Generate PDFs from mirrored HTML
        run: |
          mkdir -p "${PDF_DIR}"
          cat > hide_sections.css <<'EOF'
          [class*="header-module__Pc0Sva__header"],
          [class*="header-module__Pc0Sva__sticky"],
          [class*="footer-module__rV1DKq__footer"],
          [class*="feedback-module__j8fpJW__inlineWrapper"],
          [class*="feedback-module__j8fpJW__inlineWrapperClosed"],
          div[class*="sticky"][class*="top-"][class*="md:flex"][class*="md:shrink-0"][class*="md:flex-col"][class*="md:justify-between"] {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            overflow: hidden !important;
          }
          EOF

          find nextjs-docs -type f -name "*.html" | sort | xargs -P4 -I {} sh -c '
            out="${PDF_DIR}/$(echo "{}" | sed "s|[/:]|-|g").pdf"
            echo "Rendering {} â†’ $out"
            xvfb-run -a --auto-servernum wkhtmltopdf \
              --enable-local-file-access \
              --load-error-handling ignore \
              --no-background \
              --user-style-sheet hide_sections.css \
              "{}" "$out"
          '

      - name: Merge & compress PDF
        run: |
          mkdir -p "${FINAL_DIR}"
          pdftk ${PDF_DIR}/*.pdf cat output "${FINAL_DIR}/merged.pdf"
          gs -sDEVICE=pdfwrite -dCompatibilityLevel=1.4 -dPDFSETTINGS=/ebook \
             -dNOPAUSE -dQUIET -dBATCH \
             -sOutputFile="${FINAL_DIR}/${FINAL_PDF}" \
             "${FINAL_DIR}/merged.pdf"
          mv "${FINAL_DIR}/${FINAL_PDF}" "${FINAL_DIR}/${FINAL_PDF}"
          rm "${FINAL_DIR}/merged.pdf"

      - name: Commit PDF to main branch
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git pull --rebase origin main || git pull origin main
          git add "${FINAL_DIR}/${FINAL_PDF}"
          git commit -m "ðŸ“„ Update Next.js Docs PDF" || echo "No changes"
          git push origin main

      - name: Upload PDF as artifact
        uses: actions/upload-artifact@v4
        with:
          name: NextJS_Docs_PDF
          path: docs/NextJS_Docs_Complete.pdf