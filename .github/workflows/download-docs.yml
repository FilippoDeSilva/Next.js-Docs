name: Build Next.js Canary Docs PDF

on:
  schedule:
    - cron: '0 0 * * *' # Daily at midnight UTC
  workflow_dispatch:    # Allows manual trigger

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout this repo
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2. Install dependencies
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-xetex texlive-fonts-recommended texlive-latex-extra git

      # 3. Clone or update Next.js canary docs
      - name: Clone or update Next.js canary docs
        run: |
          DOCS_DIR=nextjs-docs/canary_docs
          if [ -d "$DOCS_DIR" ]; then
            echo "Directory exists. Pulling latest changes..."
            cd $DOCS_DIR
            git fetch origin canary
            git reset --hard origin/canary
            cd ../../
          else
            git clone --depth=1 --branch canary https://github.com/vercel/next.js.git $DOCS_DIR
          fi

      # 4. Combine all Markdown files into PDF
      - name: Generate PDF
        run: |
          OUTPUT=NextJS_Canary_Docs.pdf
          if [ -d "nextjs-docs/canary_docs/docs" ]; then
            pandoc nextjs-docs/canary_docs/docs/**/*.md \
              -o $OUTPUT \
              --pdf-engine=xelatex \
              --template=docs/nextjs-template.tex \
              -V geometry:margin=1in \
              -V linkcolor=blue \
              -V colorlinks=true \
              -V fontsize=11pt \
              -V mainfont="DejaVu Serif" \
              -V version="Canary"
          else
            echo "Docs folder not found!"
            exit 1
          fi

      # 5. Commit and push PDF to the repo
      - name: Commit PDF
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add NextJS_Canary_Docs.pdf
          git commit -m "Update Next.js Canary Docs PDF [skip ci]" || echo "No changes to commit"
          git push origin HEAD