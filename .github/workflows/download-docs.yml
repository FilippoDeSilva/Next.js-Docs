name: ðŸ§­ Next.js Docs PDF (Python Playwright Trial)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install requests playwright PyPDF2
          playwright install chromium

      - name: Write script to file
        run: |
          cat << 'EOF' > generate_docs.py
          import asyncio
          from playwright.async_api import async_playwright
          import requests, re
          from PyPDF2 import PdfMerger
          import os

          BASE_URL = "https://nextjs.org/docs"
          HEADERS = {"User-Agent": "Mozilla/5.0"}
          LIMIT = 10

          def get_links():
              html = requests.get(BASE_URL, headers=HEADERS).text
              matches = re.findall(r'href="(/docs/(app|pages)[^"]+)"', html)
              app_links, pages_links = [], []
              for href, group in matches:
                  full = f"https://nextjs.org{href}"
                  if group == "app" and full not in app_links:
                      app_links.append(full)
                  elif group == "pages" and full not in pages_links:
                      pages_links.append(full)
              return app_links[:LIMIT], pages_links[:LIMIT]

          async def render_pdf(group, links):
              os.makedirs("pdfs", exist_ok=True)
              pdf_paths = []
              async with async_playwright() as p:
                  browser = await p.chromium.launch()
                  context = await browser.new_context()
                  for i, url in enumerate(links):
                      page = await context.new_page()
                      await page.goto(url, wait_until="networkidle")
                      filename = f"pdfs/{group}_{i:02d}.pdf"
                      await page.pdf(path=filename, format="A4", print_background=True)
                      print(f"âœ… Rendered {filename}")
                      pdf_paths.append(filename)
                      await page.close()
                  await browser.close()
              return pdf_paths

          def merge_pdfs(paths, output):
              merger = PdfMerger()
              for path in paths:
                  merger.append(path)
              merger.write(output)
              merger.close()
              print(f"ðŸŽ‰ Merged into {output}")

          async def main():
              app_links, pages_links = get_links()
              print(f"ðŸ“„ Found {len(app_links)} App and {len(pages_links)} Pages docs")
              app_pdfs = await render_pdf("AppRouter", app_links)
              pages_pdfs = await render_pdf("PagesRouter", pages_links)
              merge_pdfs(app_pdfs + pages_pdfs, "NextJS_Trial_10_Docs.pdf")

          asyncio.run(main())
          EOF

      - name: Run PDF generation script
        run: python generate_docs.py

      - name: Upload Trial PDF
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-docs-trial
          path: NextJS_Trial_10_Docs.pdf